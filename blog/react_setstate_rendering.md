2024/03/26
Next.js で作成している英単語暗記アプリの開発中に直面した state の仕様について書く。

https://qiita.com/makotohanada/items/923bbf9a9e51d6aa16b3 に書かれていた記事の「型」

「はじめに」
①この記事は何か
②対象は誰か
③ねらいは何か
結論
中身
「おわりに」

これに合わせて大まかな内容を考える。

「はじめに」
- Next.js を勉強がてら英単語暗記アプリを開発中
- 初歩的だが state でぬまったため、仕様を調べたのでそれを紹介
- 対象は React 初学者
- state の仕様について理解し、同じような沼り方を防げるようにしたい

「先に結論」
- こういうことをやろうとしたら1ずれた
- setState でカウントしていた数がずれるのは「state がスナップショットのように振る舞うから」

「中身」
- 間違っていたソースコードとその結果どうなっていたか紹介
- 間違っている理由を説明
  - 関数内では state は更新されないため、更新前のカウントを渡していた
- 正しいソースコードとその結果を紹介

「おわりに」
- 感想
  - 初歩的なことかと思うが、開発中に何度か同じことが発生したのでしっかり理解できてよかった
  - 当たり前だが仕様を理解したうえで実装することが大切だと思った


4/6(Satur)
この記事のタイトルと、「state がスナップショットのように振る舞うから」というのを
どういうふうに説明すればいいか考える。
そのためにまずこの公式ドキュメントを読む。
https://ja.react.dev/learn/state-as-a-snapshot

それとこの「レンダーとコミット」というページも勉強になりそう。
https://ja.react.dev/learn/render-and-commit#step-1-trigger-a-render

勉強した内容を下に整理。
「state がスナップショットのように振る舞うから」というのは、
「コンポーネントがレンダーされるときはすべてその特定のレンダー時の state の値を使って計算される」
と説明することができそう。

ただ、さらにそれはなぜかというのをクロージャやレキシカルスコープで
説明できるとなお良さそう。
先に本文を書ききってからタイトルを考えるほうがいいかもしれない。
あとこの公式ドキュメントをすみずみまで読めば React の理解がかなり深まりそう。

## レンダーとコミット

### ステップ1 レンダーのトリガ
コンポーネントがレンダーされる理由
1. コンポーネントの初回レンダー
2. コンポーネント（またはその祖先のいずれか）の state の更新

### ステップ2 React がコンポーネントをレンダー
レンダーをトリガした後、 React はコンポーネントを呼び出して画面に表示する内容を把握する。

「レンダー」とは、 React がコンポーネントを呼び出すこと
- 初回レンダー時は React はルート (root) コンポーネントを呼び出す
- 次回以降のレンダーでは、 state の更新によってレンダーがトリガされた関数コンポーネントを React が呼び出す。

### ステップ3 React が DOM への変更をコミットする
コンポーネントをレンダー (関数として呼び出し) した後、 React は DOM を変更する。

- 初回レンダー時には、 React は appendChild() DOM API を使用して、作成した全ての DOM ノードを画面に表示する
- 再レンダー時には、 React は最新のレンダー出力に合わせて DOM を変更するため、
必要な最小限の操作 (レンダー中に計算されたもの) を適用する

React はレンダー間で違いがあった場合にのみ DOM ノードを変更する。

## state はスナップショットである

React では、ユーザーインターフェースはクリックなどのユーザーイベントに直接反応して更新されるものではなく、
state を set することで再レンダーを React に要求することで、
インターフェースがイベントに応答する。

### レンダーは時間を切り取ってスナップショットを取る

「レンダーする」とは、 React がコンポーネント (関数) を呼び出すこと。
関数から返される JSX は、その時点での UI のスナップショットのようなもの。
その JSX 内の props、イベントハンドラ、ローカル変数は全て、
レンダー時の state を使用して計算される。

コンポーネントのメモリとしての state は、関数が終了したら消えてしまう通常の変数とは異なる。
state は実際には React の中で「生存」している。
React がコンポーネントを呼び出すとき、 React はその特定のレンダーに対する state のスナップショットを提供する。

4/10(Wed)
この記事のタイトルをそろそろ考えてスラグを考えて記事を書き始めたい。
[React] レンダー時に state が更新されない理由について
react-render-state-not-updating

とりあえず記事のファイルを作成。
あとはクロージャの説明を考えながら書いていく。
↓ この辺が簡単に説明されているので参考になるかも。
https://nowokay.hatenablog.com/entries/2011/11/15#1321333375
https://qiita.com/satomi310/items/685951139983f913adeb